<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DragonGamer - Gerenciar Pessoas</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <h1>DragonGamer Admin</h1>
        <div class="nav-links">
            <a href="/admin">Dashboard</a>
            <a href="/admin/jogos">Jogos</a>
            <a href="/admin/pessoas">Pessoas</a>
            <a href="/login" onclick="localStorage.clear()">Sair</a>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2 id="formTitle">Cadastrar Nova Pessoa</h2>
            <form id="formPessoa">
                <input type="hidden" id="pessoaId">

                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="nome" required>
                </div>

                <div class="form-group">
                    <label>Matrícula</label>
                    <input type="text" id="matricula" required>
                </div>

                <div class="form-group">
                    <label id="labelSenha">Senha Inicial</label>
                    <input type="password" id="senha">
                    <small id="senhaHelp" class="senha-help">
                        Deixe em branco para manter a senha atual
                    </small>
                </div>

                <div class="form-group">
                    <label>Papel (Role)</label>
                    <select id="role">
                        <option value="USER">Usuário Comum</option>
                        <option value="ADMIN">Administrador</option>
                    </select>
                </div>

                <div class="button-group">
                    <button type="submit" id="btnSubmit">Salvar Pessoa</button>
                    <button type="button" id="btnCancel" class="btn-cancel" onclick="resetForm()">Cancelar Edição</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>Lista de Pessoas</h2>
            <div class="search-filter-bar">
                <input type="text" id="searchPessoas" placeholder="Pesquisar por nome da pessoa..." oninput="onFiltroChange()">
            </div>
            <table id="tabelaPessoas">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Matrícula</th>
                        <th>Papel</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="semResultados" class="sem-resultados" style="display:none;">Nenhuma pessoa encontrada.</p>
            <div class="paginacao" id="paginacaoPessoas"></div>
        </div>
    </div>

<script>
    const role = localStorage.getItem('role');
    if (role !== 'ADMIN') window.location.href = '/login';

    const API_BASE = '/api/admin/usuarios';
    const ITENS_POR_PAGINA = 8;
    let todasPessoas = [];
    let pessoasFiltradas = [];
    let paginaAtual = 1;

    async function carregarPessoas() {
        const response = await fetch(API_BASE, { headers: { 'x-role': 'ADMIN' } });
        todasPessoas = await response.json();
        onFiltroChange();
    }

    function onFiltroChange() {
        paginaAtual = 1;
        aplicarFiltros();
    }

    function aplicarFiltros() {
        const termo = document.getElementById('searchPessoas').value.toLowerCase().trim();

        pessoasFiltradas = todasPessoas.filter(p =>
            p.nome.toLowerCase().includes(termo)
        );

        renderizarTabela();
        renderizarPaginacao();
    }

    function renderizarTabela() {
        const tbody = document.querySelector('#tabelaPessoas tbody');
        tbody.innerHTML = '';
        const semResultados = document.getElementById('semResultados');

        if (pessoasFiltradas.length === 0) {
            semResultados.style.display = 'block';
            document.getElementById('paginacaoPessoas').innerHTML = '';
            return;
        }
        semResultados.style.display = 'none';

        const inicio = (paginaAtual - 1) * ITENS_POR_PAGINA;
        const paginaPessoas = pessoasFiltradas.slice(inicio, inicio + ITENS_POR_PAGINA);

        paginaPessoas.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${p.nome}</td>
                <td>${p.matricula}</td>
                <td>${p.role}</td>
                <td>
                    <button onclick='prepararEdicao(${JSON.stringify(p)})' class="btn-small btn-warning">Editar</button>
                    <button onclick="excluirPessoa(${p.id})" class="btn-small btn-danger">Excluir</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderizarPaginacao() {
        const container = document.getElementById('paginacaoPessoas');
        const totalPaginas = Math.ceil(pessoasFiltradas.length / ITENS_POR_PAGINA);

        if (totalPaginas <= 1) { container.innerHTML = ''; return; }

        let html = `<button class="btn-pag" onclick="irParaPagina(${paginaAtual - 1})" ${paginaAtual === 1 ? 'disabled' : ''}>&#8249;</button>`;

        for (let i = 1; i <= totalPaginas; i++) {
            if (i === 1 || i === totalPaginas || (i >= paginaAtual - 1 && i <= paginaAtual + 1)) {
                html += `<button class="btn-pag ${i === paginaAtual ? 'active' : ''}" onclick="irParaPagina(${i})">${i}</button>`;
            } else if (i === paginaAtual - 2 || i === paginaAtual + 2) {
                html += `<span class="pag-ellipsis">…</span>`;
            }
        }

        html += `<button class="btn-pag" onclick="irParaPagina(${paginaAtual + 1})" ${paginaAtual === totalPaginas ? 'disabled' : ''}>&#8250;</button>`;
        html += `<span class="pag-info">${paginaAtual} de ${totalPaginas}</span>`;
        container.innerHTML = html;
    }

    function irParaPagina(pagina) {
        const totalPaginas = Math.ceil(pessoasFiltradas.length / ITENS_POR_PAGINA);
        if (pagina < 1 || pagina > totalPaginas) return;
        paginaAtual = pagina;
        renderizarTabela();
        renderizarPaginacao();
    }

    async function excluirPessoa(id) {
        const user = JSON.parse(localStorage.getItem('user'));

        if (user.id == id) {
            alert('Você não pode excluir a si mesmo!');
            return;
        }

        if (!confirm('Deseja realmente excluir esta pessoa?')) return;

        const response = await fetch(`${API_BASE}/${id}`, {
            method: 'DELETE',
            headers: { 'x-role': 'ADMIN' }
        });

        if (response.ok) {
            alert('Pessoa excluída com sucesso!');
            carregarPessoas();
        } else {
            const data = await response.json();
            alert(data.error || 'Erro ao excluir');
        }
    }

    function prepararEdicao(p) {
        document.getElementById('formTitle').textContent = 'Editar Pessoa';
        document.getElementById('pessoaId').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('matricula').value = p.matricula;
        document.getElementById('role').value = p.role;
        document.getElementById('labelSenha').textContent = 'Nova Senha (Opcional)';
        document.getElementById('senhaHelp').classList.add('show');
        document.getElementById('btnSubmit').textContent = 'Atualizar Pessoa';
        document.getElementById('btnCancel').classList.add('show');
        window.scrollTo(0, 0);
    }

    function resetForm() {
        document.getElementById('formTitle').textContent = 'Cadastrar Nova Pessoa';
        document.getElementById('pessoaId').value = '';
        document.getElementById('formPessoa').reset();
        document.getElementById('labelSenha').textContent = 'Senha Inicial';
        document.getElementById('senhaHelp').classList.remove('show');
        document.getElementById('btnSubmit').textContent = 'Salvar Pessoa';
        document.getElementById('btnCancel').classList.remove('show');
    }

    document.getElementById('formPessoa').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('pessoaId').value;

        const payload = {
            nome: document.getElementById('nome').value,
            matricula: document.getElementById('matricula').value,
            role: document.getElementById('role').value
        };

        const senha = document.getElementById('senha').value;
        if (senha) payload.senha = senha;

        const url = id ? `${API_BASE}/${id}` : API_BASE;
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'x-role': 'ADMIN' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert(id ? 'Pessoa atualizada!' : 'Pessoa cadastrada!');
            resetForm();
            carregarPessoas();
        } else {
            const data = await response.json();
            alert(data.error || 'Erro na operação');
        }
    });

    carregarPessoas();
</script>
</body>
</html>
